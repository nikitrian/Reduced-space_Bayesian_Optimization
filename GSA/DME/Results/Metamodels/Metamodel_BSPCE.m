%
% This is a BSPCE file. It has been built with inputs normalized to [0, 1] range and matched to the desired/computed ouput 
% So it reads in inputs in [0, 1] and calculates the appropriate output 
%


function [y_out varargout] = Metamodel_BSPCE(x_in, varargin)
%
% x_in      : is of size "nxN" where n=number of inputs, N=number of
%             samples
% varargin  : can be empty = [] (currently not used by the code)
% y_out     : should be of size "m1xm2xN" where m1=number of outputs,
%             m2=number of time steps, N=number of samples
% varargout : is set varargout{1}=m1 and varargout{2}=m2 
%
%
n = 17;					% number of inputs
N = 4096;				% not used
m1 = 6;					% number of outputs
m2 = 1;					% number of time points
varargout{1} = m1;		% not currently used
varargout{2} = m2;		% not currently used

% Set the mean (of size m1-m2)
PCE_Mu(:,:) = [...
		2.92095732370777;...
		71.385245839746;...
		184627499.989112;...
		138922310.333365;...
		2.08441081271948;...
		61.8745810871972;...
	];

% Set the sigma (of size m1-m2)
PCE_Sigma(:,:) = [...
		0.72062627110956;...
		17.639093719574;...
		51905622.7489214;...
		43627898.1162972;...
		0.997839845386891;...
		11.4836150246239;...
	];

% Set the matrix of powers (of size m1-m2-n-dim)
PCE_Mat{1,1} = [...
		0,0,0,1,0,0,0,0,1,0,2,0,0,0;...
		0,0,0,0,0,0,0,1,0,0,0,0,0,0;...
		0,1,2,0,0,1,3,1,1,3,0,0,1,3;...
		0,0,0,0,0,1,0,0,0,1,0,1,1,1;...
		0,0,0,0,1,0,0,0,0,0,0,0,1,1;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
	];
PCE_Mat{2,1} = [...
		0,0,0,1,0,0,0,0,1,0,2,0,3,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,2,0;...
		0,1,2,0,0,1,3,1,1,3,0,1,1,3,3,3,3,1,5;...
		0,0,0,0,0,1,0,0,0,1,0,1,0,5,3,7,1,1,5;...
		0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,1,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
	];
PCE_Mat{3,1} = [...
		0,1,0,0,0,0,0,0,0,2,0,0,2,0,1,4,1,0,0,0;...
		0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,1,2,1,3,0,1,3,0,1,1,0,0,1,3,0,1,3,3;...
		0,0,0,0,1,0,0,0,1,0,5,3,0,1,0,0,0,7,5,7;...
		0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,1,1,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
	];
PCE_Mat{4,1} = [...
		0,0,1,0,1,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,1,0,4,0,4,0;...
		0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,5,1,5,1;...
		0,0,0,0,0,0,0,0,0,0,0;...
		0,1,0,0,1,0,0,4,0,2,0;...
		0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,1,0,0,2,1,0,1,1;...
		0,0,0,0,0,0,0,0,0,0,0;...
	];
PCE_Mat{5,1} = [...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0;...
		0,0,1,2,3,0,1,2,1,4,0,1,2,1,1,5,1,4,1,1;...
		0,0,0,0,0,0,1,0,0,0,1,3,0,0,5,0,1,1,0,1;...
		0,0,0,0,0,1,0,1,1,0,0,0,0,0,0,0,1,1,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
	];
PCE_Mat{6,1} = [...
		0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0;...
		0,1,2,0,0,0,1,3,0,0,0,1,1,1,0,1,1;...
		0,0,0,0,0,0,1,0,0,0,0,0,5,3,0,0,7;...
		0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
		0,0,0,1,0,2,0,0,0,3,0,0,0,0,1,0,0;...
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
	];

% Set the PCE coefficients (of size m1-m2-dim)
PCE_Cr{1,1} = [...
		-0.0110805596952306,0.479597923708645,-0.452836826152284,0.42754717504188,0.408493413757386,0.255903230246268,0.167361678231088,0.1277177166619,0.105011900593199,-0.0808917343868216,-0.0869750301468515,-0.0841897828057592,-0.0647195745953167,0.0638943609585291;...
	];
PCE_Cr{2,1} = [...
		-0.00961222759361099,0.488793436307885,-0.442158683377338,0.425591930489232,0.408258542370622,0.245070874820394,0.17581514698417,0.126197764363479,0.102121081821926,-0.0845176882391299,-0.0752039707153072,-0.0689826034916582,-0.0663772980913358,-0.0507176920807991,0.0441738765500258,0.0408378839051083,0.0637401686025883,-0.0447203301220478,-0.0245002869846102;...
	];
PCE_Cr{3,1} = [...
		0.00742098269714212,0.492083808818385,-0.499633280166507,0.466468455675018,-0.251662001472111,-0.165648220079996,-0.15681088123675,-0.118728904969277,0.102904716731794,0.0912891789761306,-0.0777155683929423,0.0834952041445623,0.0801105680588996,0.0811695485456188,-0.0817840869101115,0.0470111451936098,0.062330638978212,0.0510786624593037,0.044325711990572,-0.0503329765285198;...
	];
PCE_Cr{4,1} = [...
		-0.00177253446092207,0.849124727845991,0.38376153768325,0.150871115399508,0.136680557359038,0.0982538544235906,0.0927173423217239,-0.0279311474845823,-0.0755500559255407,-0.0432208327239879,-0.057063789813719;...
	];
PCE_Cr{5,1} = [...
		-0.0190824512286476,0.488686355419319,-0.434765334418144,0.387304184429778,-0.223755959217206,-0.22246247030105,-0.191907855067639,-0.125949190752566,0.119549129059335,0.103309269666432,0.105014398743593,0.0918573018742895,0.0802347607740571,-0.0804209751298612,-0.0536040603988838,-0.0804445009991125,0.0802751217018061,0.065998001944907,-0.0746783898821051,-0.0566529768558035;...
	];
PCE_Cr{6,1} = [...
		-0.00825827273387169,0.483290280043878,-0.464194038920759,-0.373454340190117,0.256367945686395,-0.226349855185348,0.223972139397185,0.211066496116732,-0.172938153305781,-0.127141234247815,0.151501233775192,0.124287464013731,0.0930123912071438,-0.0929039032510371,0.0981089594264293,-0.0646061619970477,-0.059674801101787;...
	];

% Compute the function output
f_y = zeros(m1, m2, size(x_in, 2));

for m1_ = 1:m1
	for m2_ = 1:m2

		PCE_dim = size(PCE_Cr{m1_, m2_}, 2);
		sumf = zeros(1,size(x_in, 2));
		for dim_=1:PCE_dim
			prdtf = ones(1,size(x_in, 2));
			for n_=1:n
				if (PCE_Mat{m1_,m2_}(n_,dim_) > 0)
					prdtf(1,:) = prdtf(1,:).* polyval(LegendreShiftPoly(PCE_Mat{m1_,m2_}(n_,dim_)),x_in(n_,:));
				end
			end
			prdtf(1,:) = prdtf(1,:) * PCE_Cr{m1_,m2_}(dim_);
			sumf(1,:) = sumf(1,:) + prdtf(1,:);
		end

		% Evaluate the function output
		f_y(m1_, m2_, :) = PCE_Sigma(m1_,m2_) * sumf(1,:) + PCE_Mu(m1_,m2_);

	end
end

y_out = f_y;
